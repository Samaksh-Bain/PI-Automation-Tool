<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PI Data Visualization Tool</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
      <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <script type="importmap">
    {
      "imports": {
        "@material/web/": "https://esm.run/@material/web/"
      }
    }
  </script>
  <script type="module">
    import '@material/web/all.js';
    import {styles as typescaleStyles} from '@material/web/typography/md-typescale-styles.js';

    document.adoptedStyleSheets.push(typescaleStyles.styleSheet);
  </script>

</head>
<body>
    <slot>
        <h1 class="title">PI Data Visualization Tool</h1>
        <div class="logo-container">
            <img src="{{ url_for('static', filename='log.png') }}" alt="Logo">
        </div>
    </slot>
    <div class="container">
        <div class="command-center">
            <h3 class="filtertopic">Filters</h3>
            <form method="GET" action="/" id="filter-form">
                <div class="filters">
                    <div class="filter">
                        <label for="industry">Bain Industry</label>
                        <select id="industry" name="industry">
                            <option value="">Select Industry</option>
                            {% for industry in industries %}
                                <option value="{{ industry }}" {% if request.args.get('industry') == industry %}selected{% endif %}>{{ industry }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="filter">
                        <label for="industry_primary">Primary Industry</label>
                        <select id="industry_primary" name="industry_primary">
                            <option value="">Select Primary Industry</option>
                            {% for industry_primary in industries_primary %}
                                <option value="{{ industry_primary }}" {% if request.args.get('industry_primary') == industry_primary %}selected{% endif %}>{{ industry_primary }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="filter">
                        <label for="relationship">Relationship</label>
                        <select id="relationship" name="relationship">
                            <option value="">Select Relationship</option>
                            <option value="Current" {% if request.args.get('relationship') == 'Current' %}selected{% endif %}>Current</option>
                            <option value="Recent" {% if request.args.get('relationship') == 'Recent' %}selected{% endif %}>Recent</option>
                            <option value="Greyspace" {% if request.args.get('relationship') == 'Greyspace' %}selected{% endif %}>Greyspace</option>
                        </select>
                    </div>
                    <div class="filter">
                        <label for="revenue">Revenue</label>
                        <select id="revenue" name="revenue">
                            <option value="">Select Revenue Range</option>
                            <option value="less_than_500000" {% if request.args.get('revenue') == 'less_than_500000' %}selected{% endif %}>Less than $5B</option>
                            <option value="greater_than_500000" {% if request.args.get('revenue') == 'greater_than_500000' %}selected{% endif %}>Greater than $5B</option>
                        </select>
                    </div>
                    <div class="filter">
                        <label for="combined_opp_score">Combined Opp. Score</label>
                        <select id="combined_opp_score" name="combined_opp_score">
                            <option value="">Select Score Range</option>
                            <option value="less_than_5" {% if request.args.get('combined_opp_score') == 'less_than_5' %}selected{% endif %}>Less than 5</option>
                            <option value="between_5_and_10" {% if request.args.get('combined_opp_score') == 'between_5_and_10' %}selected{% endif %}>5 to 10</option>
                            <option value="greater_than_10" {% if request.args.get('combined_opp_score') == 'greater_than_10' %}selected{% endif %}>Greater than 10</option>
                        </select>
                    </div>
                    <div class="filter">
                        <label for="Geography">Region</label>
                        <select id="Geography" name="geography">
                            <option value="">Select Region</option>
                            <option value="APAC" {% if request.args.get('geography') == 'APAC' %}selected{% endif %}>APAC</option>
                            <option value="EMEA" {% if request.args.get('geography') == 'EMEA' %}selected{% endif %}>EMEA</option>
                            <option value="AMER" {% if request.args.get('geography') == 'AMER' %}selected{% endif %}>AMER</option>
                        </select>
                        
                    </div>
                </div>
                <div class="filter multi-select-container">
                    <label for="country">Country</label>
                    <div id="country" class="multi-select-selected">
                        Select Country
                    </div>
                    <div class="multi-select-dropdown">
                        <div class="multi-select-search">
                            <input type="text" placeholder="Search...">
                        </div>
                        <div class="multi-select-buttons">
                            <button id="select-all" class="multi-select-button">Select all</button>
                            <button id="clear-all" class="multi-select-button">Clear all</button>
                        </div>
                        {% set selected_countries = request.args.getlist('country[]') %}
                        <div class="multi-select-options-container">
                            {% for country in countries %}
                            <div class="multi-select-option">
                                <input type="checkbox" id="country_{{ country }}" name="country[]" value="{{ country }}" {% if country in selected_countries %}checked{% endif %}>
                                <label for="country_{{ country }}">{{ country }}</label>
                            </div>
                            {% endfor %}
                        </div>
                        <button id="apply-selection" class="multi-select-apply">Apply</button>
                    </div>
                </div>
                
                
                        </select>
                    </form>
                    <form method="POST" action="/generate_ppt">
                        <input type="hidden" name="industry" id="hidden-industry">
                        <input type="hidden" name="relationship" id="hidden-relationship">
                        <input type="hidden" name="revenue" id="hidden-revenue">
                        <input type="hidden" name="country" id="hidden-country">
                        <input type="hidden" name="combined_opp_score" id="hidden-combined-opp-score">  <!-- New hidden input -->
                        <button type="submit" onclick="copyFiltersToHiddenInputs()">Generate PPT</button>
                    </form>
                        <div class="foot-container">
                            <h2> Developed By BCN Visualization COE</h2>
                        </div>
                </div>
            
        </div>
    </div>

</div>
<div class="content">
    {% if filters_applied %}
        <h2 class="fixed-title">
            {% if industry %}{{ industry }}{% endif %}
            {% if revenue == 'less_than_500000' %}Less than $5B{% elif revenue == 'greater_than_500000' %}Greater than $5B{% endif %}
            Potential Targets In
            {% if selected_countries %}{{ selected_countries | join(",") }}{% endif %}
            {% if relationship %}({{ relationship }}){% endif %}
        </h2>
        {% if filtered_data %}
        <div id="chart-container" class="chart-container">
            <canvas id="chart"></canvas>
        </div>
        <div class="data-table" id="table-view">
            <table id="data-table">
                <thead>
                    <tr>
                        <th colspan="11" style="text-align: center; position: relative;">
                            <div style="display: flex; justify-content: space-between; align-items: left; width: 100%;">
                                <div style="flex: 1; display: flex; justify-content: left;">
                                    <span class="sort-pointer" style="white-space: nowrap;">* Sort by clicking on column name</span>
                                </div>
                                <div>
                                <img src="{{ url_for('static', filename='Legend.png') }}" alt="Legend" class="legend">
                            </div>
                        </th>
                    </tr>
                    <tr style="text-align: center;">
                        <th style="cursor: pointer;" onclick="sortTable(0)">Company</th>
                        <th style="cursor: pointer; text-align: center;" onclick="sortTableByRevenue(1)">Revenue ($B)</th>
                        <th style="cursor: pointer; text-align: center;" onclick="sortTableBySector(2)">Sector</th>
                        <th style="cursor: pointer; text-align: center;" onclick="sortTableByEBITChange(3)">EBIT % pt change</th>
                        <th style="cursor: pointer; text-align: center;" onclick="sortTableByEBITOpportunity(4)">EBIT opportunity ($M)</th>
                        <th style="cursor: pointer; text-align: center;" onclick="sortTableBySGAOpportunity(5)">SG&A opportunity ($M)</th>
                        <th style="cursor: pointer; text-align: center;" onclick="sortTableByNWCOpportunity(6)">NWC opportunity ($M)</th>                        
                        <th style="cursor: pointer; text-align: center;" onclick="sortTableByProjectedRevenueOpportunity(7)">Projected revenue opportunity '22-'24 ($M)</th>
                        <th style="cursor: pointer; text-align: center;" onclick="sortTableByHistoricalRevenueGrowth(8)">Historical revenue growth '22 vs '21</th>                        
                        <th style="cursor: pointer; text-align: center;" onclick="sortTableByNetDebtEBITDA(9)">Net Debt / EBITDA</th>
                        <th style="cursor: pointer; text-align: center;" onclick="sortTableByESGScore(10)">Relative ESG score</th>
                    </tr>
                </thead>
                <tbody>
                    {% for row in filtered_data %}
                    <tr>
                        <td>{{ row['Company'] }}</td>
                        <td style="text-align: center;">{{ "%.1f" | format(row['Revenue (M)'] /1000) }}</td>
                        <td>{{ row['Primary Industry'] }}</td>
                        <td style="text-align: center;">
                            {% set ebit_change = row['EBIT margin Change (% pts.)  [Benchmark year-Base year]'] %}
                            {% if ebit_change and ebit_change|float is not none %}
                                {% set ebit_change = ebit_change|float %}
                                {% if ebit_change * 100 > 0 %}
                                    <span>{{ "%.1f" | format(ebit_change * 100) }} <i class="fas fa-arrow-up" style="color:green;"></i></span>
                                {% else %}
                                    <span>{{ "%.1f" | format(ebit_change * 100) }} <i class="fas fa-arrow-down" style="color:red;"></i></span>
                                {% endif %}
                            {% else %}
                                <span>N/A</span>
                            {% endif %}
                        </td>
                        <td style="text-align: center;" >{{ row['Static EBIT opportunity (Median)'] }}</td>
                        <td style="text-align: center;" >{{ row['Static SG&A Opportunity (Median)'] }}</td>
                        <td style="text-align: center;" >{{ row['Static NWC opportunity (Median)'] }}</td>
                        <td style="text-align: center;" >{{ row["Median Incremental Rev. - EBIT Oppty (Static Projected)"] }}</td>
                        <td style="text-align: center;">
                            {% set historical_rev_cagr = row["Historical rev. CAGR"] %}
                            {% if historical_rev_cagr and historical_rev_cagr|float is not none %}
                                {% set historical_rev_cagr = historical_rev_cagr|float %}
                                {{ "%.0f" | format(historical_rev_cagr * 100) }}%
                            {% else %}
                                N/A
                            {% endif %}
                        </td>
                        <td style="text-align: center;" >
                            {% if row["Net debt/EBITDA (Dec'22)"]|float %}
                                <span>{{ row["Net debt/EBITDA (Dec'22)"] }}x</span>
                            {% else %}
                                <span>{{ row["Net debt/EBITDA (Dec'22)"] }}</span>
                            {% endif %}
                        </td>
                        <td style="text-align: center;">
                            {% if row['Relative ESG Combined score'] == "Above Top Q" %}
                                <span style="color: #507867; font-size: 2.5em;">&#9679;</span> <!-- Green circle indicator -->
                            {% elif row['Relative ESG Combined score'] == "Above Median" %}
                                <span style="color: #E9CD49; font-size: 2.5em;">&#9679;</span> <!-- Yellow circle indicator -->
                            {% elif row['Relative ESG Combined score'] == "Below Median" %}
                                <span style="color: #CC0000; font-size: 2.5em;">&#9679;</span> <!-- Red circle indicator -->
                            {% else %}
                                <span>{{ row['Relative ESG Combined score'] }}</span> <!-- No circle indicator for other values -->
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <p>No data available</p>
        {% endif %}

    {% endif %}
</div>

<script>

    function sortTable(columnIndex) {
        var table = document.getElementById("data-table");
        var rows = Array.from(table.rows).slice(2); // Skip the first two header rows
        var isAscending = table.getAttribute("data-sort-order") === "asc";
        
        rows.sort(function(a, b) {
            var cellA = a.cells[columnIndex].textContent.trim();
            var cellB = b.cells[columnIndex].textContent.trim();
            
            if (!isNaN(cellA) && !isNaN(cellB)) {
                // Sort numbers
                cellA = parseFloat(cellA);
                cellB = parseFloat(cellB);
            }

            if (cellA < cellB) {
                return isAscending ? -1 : 1;
            }
            if (cellA > cellB) {
                return isAscending ? 1 : -1;
            }
            return 0;
        });

        // Reverse the sort order for next click
        table.setAttribute("data-sort-order", isAscending ? "desc" : "asc");

        // Reattach sorted rows
        for (var i = 0; i < rows.length; i++) {
            table.tBodies[0].appendChild(rows[i]);
        }
    }

    function sortTableByRevenue(columnIndex) {
        var table = document.getElementById("data-table");
        var rows = Array.from(table.rows).slice(2); // Skip the first two header rows
        var isAscending = table.getAttribute("data-sort-order-revenue") === "asc";
        
        rows.sort(function(a, b) {
            var cellA = parseFloat(a.cells[columnIndex].textContent.trim());
            var cellB = parseFloat(b.cells[columnIndex].textContent.trim());

            if (isNaN(cellA)) cellA = -Infinity; // Handle cases where the cell content is not a number
            if (isNaN(cellB)) cellB = -Infinity;

            if (cellA < cellB) {
                return isAscending ? -1 : 1;
            }
            if (cellA > cellB) {
                return isAscending ? 1 : -1;
            }
            return 0;
        });

        // Reverse the sort order for next click
        table.setAttribute("data-sort-order-revenue", isAscending ? "desc" : "asc");

        // Reattach sorted rows
        for (var i = 0; i < rows.length; i++) {
            table.tBodies[0].appendChild(rows[i]);
        }
    }

    function sortTableBySector(columnIndex) {
        var table = document.getElementById("data-table");
        var rows = Array.from(table.rows).slice(2); // Skip the first two header rows
        var isAscending = table.getAttribute("data-sort-order-sector") === "asc";

        rows.sort(function(a, b) {
            var cellA = a.cells[columnIndex].textContent.trim().toLowerCase();
            var cellB = b.cells[columnIndex].textContent.trim().toLowerCase();

            if (cellA < cellB) {
                return isAscending ? -1 : 1;
            }
            if (cellA > cellB) {
                return isAscending ? 1 : -1;
            }
            return 0;
        });

        // Reverse the sort order for next click
        table.setAttribute("data-sort-order-sector", isAscending ? "desc" : "asc");

        // Reattach sorted rows
        for (var i = 0; i < rows.length; i++) {
            table.tBodies[0].appendChild(rows[i]);
        }
    }

    function sortTableByEBITChange(columnIndex) {
        var table = document.getElementById("data-table");
        var rows = Array.from(table.rows).slice(2); // Skip the first two header rows
        var isAscending = table.getAttribute("data-sort-order-ebit") === "asc";
        
        rows.sort(function(a, b) {
            var cellA = parseFloat(a.cells[columnIndex].textContent.trim());
            var cellB = parseFloat(b.cells[columnIndex].textContent.trim());

            if (isNaN(cellA)) cellA = -Infinity; // Handle cases where the cell content is not a number
            if (isNaN(cellB)) cellB = -Infinity;

            if (cellA < cellB) {
                return isAscending ? -1 : 1;
            }
            if (cellA > cellB) {
                return isAscending ? 1 : -1;
            }
            return 0;
        });

        // Reverse the sort order for next click
        table.setAttribute("data-sort-order-ebit", isAscending ? "desc" : "asc");

        // Reattach sorted rows
        for (var i = 0; i < rows.length; i++) {
            table.tBodies[0].appendChild(rows[i]);
        }
    }

    function sortTableByEBITOpportunity(columnIndex) {
        var table = document.getElementById("data-table");
        var rows = Array.from(table.rows).slice(2); // Skip the first two header rows
        var isAscending = table.getAttribute("data-sort-order-ebit-opportunity") === "asc";
        
        rows.sort(function(a, b) {
            var cellA = parseFloat(a.cells[columnIndex].textContent.trim());
            var cellB = parseFloat(b.cells[columnIndex].textContent.trim());

            if (isNaN(cellA)) cellA = -Infinity; // Handle cases where the cell content is not a number
            if (isNaN(cellB)) cellB = -Infinity;

            if (cellA < cellB) {
                return isAscending ? -1 : 1;
            }
            if (cellA > cellB) {
                return isAscending ? 1 : -1;
            }
            return 0;
        });

        // Reverse the sort order for next click
        table.setAttribute("data-sort-order-ebit-opportunity", isAscending ? "desc" : "asc");

        // Reattach sorted rows
        for (var i = 0; i < rows.length; i++) {
            table.tBodies[0].appendChild(rows[i]);
        }
    }

    function sortTableBySGAOpportunity(columnIndex) {
        var table = document.getElementById("data-table");
        var rows = Array.from(table.rows).slice(2); // Skip the first two header rows
        var isAscending = table.getAttribute("data-sort-order-sga-opportunity") === "asc";
        
        rows.sort(function(a, b) {
            var cellA = parseFloat(a.cells[columnIndex].textContent.trim());
            var cellB = parseFloat(b.cells[columnIndex].textContent.trim());

            if (isNaN(cellA)) cellA = -Infinity; // Handle cases where the cell content is not a number
            if (isNaN(cellB)) cellB = -Infinity;

            if (cellA < cellB) {
                return isAscending ? -1 : 1;
            }
            if (cellA > cellB) {
                return isAscending ? 1 : -1;
            }
            return 0;
        });

        // Reverse the sort order for next click
        table.setAttribute("data-sort-order-sga-opportunity", isAscending ? "desc" : "asc");

        // Reattach sorted rows
        for (var i = 0; i < rows.length; i++) {
            table.tBodies[0].appendChild(rows[i]);
        }
    }

    function sortTableByNWCOpportunity(columnIndex) {
        var table = document.getElementById("data-table");
        var rows = Array.from(table.rows).slice(2); // Skip the first two header rows
        var isAscending = table.getAttribute("data-sort-order-nwc-opportunity") === "asc";
        
        rows.sort(function(a, b) {
            var cellA = parseFloat(a.cells[columnIndex].textContent.trim());
            var cellB = parseFloat(b.cells[columnIndex].textContent.trim());

            if (isNaN(cellA)) cellA = -Infinity; // Handle cases where the cell content is not a number
            if (isNaN(cellB)) cellB = -Infinity;

            if (cellA < cellB) {
                return isAscending ? -1 : 1;
            }
            if (cellA > cellB) {
                return isAscending ? 1 : -1;
            }
            return 0;
        });

        // Reverse the sort order for next click
        table.setAttribute("data-sort-order-nwc-opportunity", isAscending ? "desc" : "asc");

        // Reattach sorted rows
        for (var i = 0; i < rows.length; i++) {
            table.tBodies[0].appendChild(rows[i]);
        }
    }

    function sortTableByProjectedRevenueOpportunity(columnIndex) {
        var table = document.getElementById("data-table");
        var rows = Array.from(table.rows).slice(2); // Skip the first two header rows
        var isAscending = table.getAttribute("data-sort-order-projected-revenue-opportunity") === "asc";
        
        rows.sort(function(a, b) {
            var cellA = parseFloat(a.cells[columnIndex].textContent.trim());
            var cellB = parseFloat(b.cells[columnIndex].textContent.trim());

            if (isNaN(cellA)) cellA = -Infinity; // Handle cases where the cell content is not a number
            if (isNaN(cellB)) cellB = -Infinity;

            if (cellA < cellB) {
                return isAscending ? -1 : 1;
            }
            if (cellA > cellB) {
                return isAscending ? 1 : -1;
            }
            return 0;
        });

        // Reverse the sort order for next click
        table.setAttribute("data-sort-order-projected-revenue-opportunity", isAscending ? "desc" : "asc");

        // Reattach sorted rows
        for (var i = 0; i < rows.length; i++) {
            table.tBodies[0].appendChild(rows[i]);
        }
    }

    function sortTableByHistoricalRevenueGrowth(columnIndex) {
        var table = document.getElementById("data-table");
        var rows = Array.from(table.rows).slice(2); // Skip the first two header rows
        var isAscending = table.getAttribute("data-sort-order-historical-revenue-growth") === "asc";
        
        rows.sort(function(a, b) {
            var cellA = parseFloat(a.cells[columnIndex].textContent.trim());
            var cellB = parseFloat(b.cells[columnIndex].textContent.trim());

            if (isNaN(cellA)) cellA = -Infinity; // Handle cases where the cell content is not a number
            if (isNaN(cellB)) cellB = -Infinity;

            if (cellA < cellB) {
                return isAscending ? -1 : 1;
            }
            if (cellA > cellB) {
                return isAscending ? 1 : -1;
            }
            return 0;
        });

        // Reverse the sort order for next click
        table.setAttribute("data-sort-order-historical-revenue-growth", isAscending ? "desc" : "asc");

        // Reattach sorted rows
        for (var i = 0; i < rows.length; i++) {
            table.tBodies[0].appendChild(rows[i]);
        }
    }

    function sortTableByNetDebtEBITDA(columnIndex) {
        var table = document.getElementById("data-table");
        var rows = Array.from(table.rows).slice(2); // Skip the first two header rows
        var isAscending = table.getAttribute("data-sort-order-net-debt-ebitda") === "asc";
        
        rows.sort(function(a, b) {
            var cellA = parseFloat(a.cells[columnIndex].textContent.trim());
            var cellB = parseFloat(b.cells[columnIndex].textContent.trim());

            if (isNaN(cellA)) cellA = -Infinity; // Handle cases where the cell content is not a number
            if (isNaN(cellB)) cellB = -Infinity;

            if (cellA < cellB) {
                return isAscending ? -1 : 1;
            }
            if (cellA > cellB) {
                return isAscending ? 1 : -1;
            }
            return 0;
        });

        // Reverse the sort order for next click
        table.setAttribute("data-sort-order-net-debt-ebitda", isAscending ? "desc" : "asc");

        // Reattach sorted rows
        for (var i = 0; i < rows.length; i++) {
            table.tBodies[0].appendChild(rows[i]);
        }
    }

    function sortTableByESGScore(columnIndex) {
        var table = document.getElementById("data-table");
        var rows = Array.from(table.rows).slice(2); // Skip the first two header rows
        var isAscending = table.getAttribute("data-sort-order-esg-score") === "asc";
        
        const order = {
            "Above Top Q": 1,
            "Above Median": 2,
            "Below Median": 3
        };
        
        rows.sort(function(a, b) {
            var cellA = a.cells[columnIndex].textContent.trim();
            var cellB = b.cells[columnIndex].textContent.trim();
            
            var valueA = order[cellA] || 4; // Default to 4 for undefined values
            var valueB = order[cellB] || 4;

            if (valueA < valueB) {
                return isAscending ? -1 : 1;
            }
            if (valueA > valueB) {
                return isAscending ? 1 : -1;
            }
            return 0;
        });

        // Reverse the sort order for next click
        table.setAttribute("data-sort-order-esg-score", isAscending ? "desc" : "asc");

        // Reattach sorted rows
        for (var i = 0; i < rows.length; i++) {
            table.tBodies[0].appendChild(rows[i]);
        }
    }

</script>


<script>
    const priorityCompanies = {{ priority_companies | tojson | safe }};
</script>



    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="{{ url_for('static', filename='script.js') }}"></script>
    <script>
        const filteredData = {{ filtered_data | tojson | safe }};
        const backgroundImageUrl = "{{ url_for('static', filename='temp1.png') }}";
        const xAxisImageUrl = "{{ url_for('static', filename='a.png') }}";
        const yAxisImageUrl = "{{ url_for('static', filename='bottom axis.png') }}";
    </script>
 
</body>
</html>
